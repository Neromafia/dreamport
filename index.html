<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIO DreamPort</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- THEME CYBERPUNK --- */
        :root {
            --bg-dark: #0b1120;
            --glass: rgba(17, 24, 39, 0.85);
            --accent: #6366f1; /* Indigo */
            --accent-glow: rgba(99, 102, 241, 0.5);
            --text-main: #f1f5f9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(11, 17, 32, 0.95), rgba(11, 17, 32, 0.9)),
                url("https://www.transparenttextures.com/patterns/carbon-fibre.png");
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        /* UI Components */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .glass-input {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s ease;
        }
        .glass-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
            outline: none;
            background: rgba(30, 41, 59, 0.9);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animations */
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse-slow { animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-new { background: #3b82f6; color: white; }
        .status-contacted { background: #f59e0b; color: black; }
        .status-win { background: #10b981; color: white; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .status-lost { background: #ef4444; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ================= CONFIGURATION =================
        const DEFAULT_KEYS = [
            "AIzaSyB014e36AW3uRbTcjminS7otM7R2F98HFs",
            "AIzaSyDv_I0dQqS0fHWVuUoIX6z0grMhqKZeiqU",
            "AIzaSyCfVBBpEXDHko9HjofnuCya1lBhQCbQjgs",
            "AIzaSyAhqjXbwivzkEysOJUrO_oHsdqZkxUTnvQ"
        ];

        // Model Pool theo y√™u c·∫ßu
        const MODEL_POOL = [
            "gemini-flash-lite-latest", 
            "gemini-2.0-flash-lite-preview-02-05", 
            "gemini-2.0-flash", 
            "gemini-2.5-flash"
        ];

        // ================= CORE SERVICES =================
        
        // 1. UTILS
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(num);

        // 2. CSV PARSER & CLOUD PUSH
        const parseCSV = (text) => {
            const rows = []; let currentRow = []; let currentCell = ""; let inQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (inQuote) { if (char === '"' && text[i + 1] === '"') { currentCell += '"'; i++; } else if (char === '"') inQuote = false; else currentCell += char; } 
                else { if (char === '"') inQuote = true; else if (char === ',') { currentRow.push(currentCell.trim()); currentCell = ""; } else if (char === '\n' || char === '\r') { if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); } currentRow = []; currentCell = ""; if (char === '\r' && text[i + 1] === '\n') i++; } else currentCell += char; }
            }
            if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
            return rows;
        };

        const pushToCloud = async (scriptUrl, content, setLog) => {
            if (!scriptUrl) return false;
            if(setLog) setLog("‚òÅÔ∏è Push Cloud...");
            try {
                await fetch(scriptUrl, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ content: content }) });
                if(setLog) setLog("‚úÖ Sent to Sheet!"); return true;
            } catch (error) { if(setLog) setLog("‚ùå Error: " + error.message); return false; }
        };

        // 3. DOWNLOADER & GEMINI CORE
        const extractUrlFromInput = (input) => {
            const srcMatch = input.match(/src=["'](.*?)["']/);
            if (srcMatch && srcMatch[1]) { const txt = document.createElement("textarea"); txt.innerHTML = srcMatch[1]; return txt.value; }
            if (input.startsWith("http")) return input.trim(); return null;
        };

        const downloadFileFromUrl = async (url, setLog) => {
            setLog(`üîó Analyzing...`);
            try { const response = await fetch(url); if (response.ok) { setLog(`‚¨áÔ∏è Direct DL...`); const blob = await response.blob(); return { blob, type: blob.type }; } } catch (e) {}
            try { setLog(`üåê Proxy DL...`); const proxyUrl = `https://corsproxy.io/?` + encodeURIComponent(url); const response = await fetch(proxyUrl); if (!response.ok) throw new Error(`Proxy Err`); setLog(`‚¨áÔ∏è RAM Loading...`); const blob = await response.blob(); let type = blob.type; if (!type) { if (url.includes('.mp4')) type = 'video/mp4'; else if (url.includes('.png')) type = 'image/png'; else if (url.includes('.jpg')) type = 'image/jpeg'; } return { blob, type }; } catch (err) { throw new Error("DL Failed."); }
        };

        const blobToBase64 = (blob) => { return new Promise((resolve) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result.split(',')[1]); reader.readAsDataURL(blob); }); };

        // ** CORE AI FUNCTION WITH MODEL ROTATION **
        const generateContentWithRetry = async (keys, prompt, blob, mimeType, setLog) => {
            let availableKeys = [...keys];
            // Nested Loop: Loop Keys -> Loop Models
            for (let k = 0; k < availableKeys.length; k++) {
                const currentKey = availableKeys[k];
                
                for (let m = 0; m < MODEL_POOL.length; m++) {
                    const currentModel = MODEL_POOL[m];
                    try {
                        if (setLog) setLog(`ü§ñ K${k+1} | ${currentModel.replace('gemini-', '')}...`);
                        
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${currentKey}`;
                        let contents = [{ parts: [{ text: prompt }] }];
                        if (blob) { const base64Data = await blobToBase64(blob); contents[0].parts.push({ inlineData: { data: base64Data, mimeType: mimeType } }); }
                        
                        const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents }) });
                        const data = await response.json();
                        
                        if (data.error) { 
                            const code = data.error.code;
                            const msg = data.error.message;
                            if (code === 503) {
                                if (setLog) setLog(`‚ö†Ô∏è 503 Busy. Switching Model...`);
                                continue; 
                            }
                            if (code === 429 || msg.includes("RESOURCE_EXHAUSTED")) {
                                if (setLog) setLog(`‚ö†Ô∏è 429 Quota. Switching Key...`);
                                break; 
                            }
                            throw new Error(msg); 
                        }
                        
                        if (setLog) setLog(`‚úÖ Success!`);
                        return data.candidates[0].content.parts[0].text;

                    } catch (err) {
                        if (k === availableKeys.length - 1 && m === MODEL_POOL.length - 1) throw err;
                    }
                }
            }
            throw new Error("All Keys & Models exhausted.");
        };

        // ================= UI COMPONENTS =================

        const Sidebar = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'dashboard', icon: 'fa-chart-line', label: 'Dashboard' },
                { id: 'crm', icon: 'fa-users', label: 'CRM & Leads' },
                { id: 'sales', icon: 'fa-headset', label: 'Sales Copilot' },
                { id: 'link_hunter', icon: 'fa-link', label: 'Link Hunter' },
                { id: 'knowledge', icon: 'fa-book-open', label: 'Knowledge' },
                { id: 'consult', icon: 'fa-wrench', label: 'Tech Consult' },
                { id: 'settings', icon: 'fa-cog', label: 'Settings' },
            ];

            return (
                <div className="w-64 glass-panel h-[95vh] m-4 flex flex-col p-4 relative z-10 shrink-0">
                    <div className="flex items-center gap-3 mb-8 px-2">
                        <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center animate-pulse-slow">
                            <i className="fa-solid fa-gem text-white"></i>
                        </div>
                        <div>
                            <h1 className="font-bold text-lg tracking-wider text-white">DREAMPORT</h1>
                            <p className="text-[10px] text-slate-400">Nero Mafia</p>
                        </div>
                    </div>
                    <div className="flex flex-col gap-2 overflow-y-auto flex-1">
                        {tabs.map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 text-sm ${activeTab === tab.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'}`}>
                                <i className={`fa-solid ${tab.icon} w-5`}></i> <span className="font-medium">{tab.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- DASHBOARD TAB ---
        const DashboardTab = ({ leads }) => {
            const stats = useMemo(() => {
                const total = leads.length;
                const wins = leads.filter(l => l.status === 'win');
                const revenue = wins.reduce((acc, curr) => acc + (Number(curr.profit) || 0), 0);
                const sales = wins.reduce((acc, curr) => acc + (Number(curr.price) || 0), 0);
                const lost = leads.filter(l => l.status === 'lost').length;
                return { total, wins: wins.length, revenue, sales, lost };
            }, [leads]);

            return (
                <div className="p-8 h-full overflow-y-auto">
                    <h2 className="text-3xl font-bold mb-6 text-white">Income & Performance</h2>
                    <div className="grid grid-cols-4 gap-6 mb-8">
                        <div className="glass-panel p-6 border-l-4 border-green-500">
                            <div className="text-slate-400 text-xs uppercase mb-1">Total Net Profit (Income)</div>
                            <div className="text-3xl font-bold text-green-400">{formatCurrency(stats.revenue)}</div>
                        </div>
                        <div className="glass-panel p-6 border-l-4 border-indigo-500">
                            <div className="text-slate-400 text-xs uppercase mb-1">Total Sales Volume</div>
                            <div className="text-3xl font-bold text-indigo-400">{formatCurrency(stats.sales)}</div>
                        </div>
                        <div className="glass-panel p-6 border-l-4 border-blue-500">
                            <div className="text-slate-400 text-xs uppercase mb-1">Conversion Rate</div>
                            <div className="text-3xl font-bold text-blue-400">{stats.total ? ((stats.wins/stats.total)*100).toFixed(1) : 0}%</div>
                        </div>
                        <div className="glass-panel p-6 border-l-4 border-slate-500">
                            <div className="text-slate-400 text-xs uppercase mb-1">Open Leads</div>
                            <div className="text-3xl font-bold text-slate-200">{stats.total - stats.wins - stats.lost}</div>
                        </div>
                    </div>
                    <div className="glass-panel p-6">
                        <h3 className="text-white font-bold mb-4">Recent Wins</h3>
                        <table className="w-full text-sm text-left text-slate-300">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-800/50">
                                <tr>
                                    <th className="px-4 py-3">Date</th>
                                    <th className="px-4 py-3">Customer</th>
                                    <th className="px-4 py-3">Dest</th>
                                    <th className="px-4 py-3 text-right">Sale Price</th>
                                    <th className="px-4 py-3 text-right">Profit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {leads.filter(l => l.status === 'win').slice(0, 10).map(lead => (
                                    <tr key={lead.id} className="border-b border-slate-700/50 hover:bg-slate-700/20">
                                        <td className="px-4 py-3">{new Date(lead.createdAt).toLocaleDateString()}</td>
                                        <td className="px-4 py-3 font-bold text-white">{lead.name}</td>
                                        <td className="px-4 py-3">{lead.dest}</td>
                                        <td className="px-4 py-3 text-right">{formatCurrency(lead.price)}</td>
                                        <td className="px-4 py-3 text-right text-green-400">{formatCurrency(lead.profit)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- CRM TAB ---
        const CRMTab = ({ leads, setLeads, onSelectLead }) => {
            const [newLead, setNewLead] = useState({ name: "", dest: "", dates: "", budget: "", pax: 1, notes: "" });
            const [showForm, setShowForm] = useState(false);

            const handleAdd = () => {
                if(!newLead.name) return alert("Nh·∫≠p t√™n kh√°ch!");
                const lead = { id: generateId(), ...newLead, status: 'new', createdAt: new Date().toISOString(), price: 0, profit: 0 };
                setLeads([lead, ...leads]);
                setNewLead({ name: "", dest: "", dates: "", budget: "", pax: 1, notes: "" });
                setShowForm(false);
            };

            const updateStatus = (id, status) => { setLeads(leads.map(l => l.id === id ? { ...l, status } : l)); };

            return (
                <div className="p-6 h-full flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-white">Customer Database</h2>
                        <button onClick={() => setShowForm(!showForm)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg flex items-center gap-2"><i className="fa-solid fa-plus"></i> Add Lead</button>
                    </div>
                    {showForm && (
                        <div className="glass-panel p-4 mb-6 grid grid-cols-2 gap-4 animate-pulse-slow border border-indigo-500/50">
                            <input className="glass-input p-2 rounded" placeholder="Name" value={newLead.name} onChange={e => setNewLead({...newLead, name: e.target.value})} />
                            <input className="glass-input p-2 rounded" placeholder="Destination" value={newLead.dest} onChange={e => setNewLead({...newLead, dest: e.target.value})} />
                            <input className="glass-input p-2 rounded" placeholder="Dates" value={newLead.dates} onChange={e => setNewLead({...newLead, dates: e.target.value})} />
                            <div className="flex gap-2">
                                <input type="number" className="glass-input p-2 rounded flex-1" placeholder="Budget ($)" value={newLead.budget} onChange={e => setNewLead({...newLead, budget: e.target.value})} />
                                <input type="number" className="glass-input p-2 rounded w-20" placeholder="Pax" value={newLead.pax} onChange={e => setNewLead({...newLead, pax: e.target.value})} />
                            </div>
                            <input className="glass-input p-2 rounded col-span-2" placeholder="Notes" value={newLead.notes} onChange={e => setNewLead({...newLead, notes: e.target.value})} />
                            <button onClick={handleAdd} className="col-span-2 bg-green-600 text-white py-2 rounded font-bold">Save Customer</button>
                        </div>
                    )}
                    <div className="flex-1 overflow-y-auto">
                        <table className="w-full text-sm text-left text-slate-300">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-800/50 sticky top-0">
                                <tr>
                                    <th className="px-4 py-3">Customer</th>
                                    <th className="px-4 py-3">Dest / Dates</th>
                                    <th className="px-4 py-3">Budget / Pax</th>
                                    <th className="px-4 py-3">Status</th>
                                    <th className="px-4 py-3 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {leads.map(lead => (
                                    <tr key={lead.id} className="border-b border-slate-700/50 hover:bg-slate-700/20 group">
                                        <td className="px-4 py-3 font-medium text-white">{lead.name}</td>
                                        <td className="px-4 py-3"><div className="text-white">{lead.dest}</div><div className="text-xs text-slate-500">{lead.dates}</div></td>
                                        <td className="px-4 py-3"><div className="text-green-400">${lead.budget}</div><div className="text-xs text-slate-500">{lead.pax} pax</div></td>
                                        <td className="px-4 py-3">
                                            <select value={lead.status} onChange={(e) => updateStatus(lead.id, e.target.value)} className={`bg-slate-800 text-xs rounded px-2 py-1 border border-slate-600 outline-none ${lead.status === 'new' ? 'text-blue-400' : lead.status === 'win' ? 'text-green-400 font-bold' : lead.status === 'lost' ? 'text-red-400' : 'text-yellow-400'}`}>
                                                <option value="new">New</option><option value="contacted">Contacted</option><option value="win">Win (Sold)</option><option value="lost">Lost</option>
                                            </select>
                                        </td>
                                        <td className="px-4 py-3 text-right"><button onClick={() => onSelectLead(lead)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded text-xs"><i className="fa-solid fa-headset mr-1"></i> Call</button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- SALES COPILOT TAB ---
        const SalesTab = ({ apiKeys, activeLead, updateLead }) => {
            const [localLead, setLocalLead] = useState(activeLead || { name: "", dest: "", budget: "", pax: 1, net: "", markup: 50 });
            const [script, setScript] = useState("Ch·ªçn kh√°ch t·ª´ CRM ho·∫∑c nh·∫≠p tay ƒë·ªÉ b·∫Øt ƒë·∫ßu.");
            const [loading, setLoading] = useState(false);

            useEffect(() => { if(activeLead) setLocalLead({...activeLead, net: activeLead.net || "", markup: activeLead.markup || 50}); }, [activeLead]);

            const totalPerPax = Number(localLead.net) + Number(localLead.markup);
            const totalAll = totalPerPax * Number(localLead.pax);
            
            const saveDeal = () => {
                if(updateLead && activeLead) {
                    updateLead({ ...localLead, price: totalAll, profit: Number(localLead.markup) * Number(localLead.pax), status: 'win' });
                    alert("ƒê√£ l∆∞u ch·ªët sale! Ki·ªÉm tra Dashboard.");
                }
            };

            const runScenario = async (type) => {
                if(apiKeys.length === 0) return alert("C·∫ßn Key!");
                setLoading(true);
                const prompts = {
                    intro: `Opening script for ${localLead.name} wanting to go to ${localLead.dest}.`,
                    price: `Reveal price $${totalAll} using 'Anchoring'. Compare to higher online price.`,
                    obj_exp: `Handle 'Too Expensive'. Use FOMO (2 seats left). Price $${totalAll}.`,
                    obj_wife: `Handle 'Ask Wife'. Offer Free Hold.`,
                    close: `Ask for Credit Card. Create urgency.`
                };
                try {
                    const txt = await generateContentWithRetry(apiKeys, `Sales Script (English/Vietnamese). Client: ${localLead.name}, Dest: ${localLead.dest}. Task: ${prompts[type]}`, null, null, null);
                    setScript(txt);
                } catch (e) { setScript(e.message); } finally { setLoading(false); }
            };

            return (
                <div className="p-6 h-full flex gap-6">
                    <div className="w-1/3 flex flex-col gap-4 overflow-y-auto no-scrollbar">
                        <div className="glass-panel p-4">
                            <h3 className="text-indigo-400 font-bold text-sm mb-3">Customer Info</h3>
                            <div className="space-y-2 text-sm">
                                <input className="glass-input w-full p-2 rounded" placeholder="Name" value={localLead.name} onChange={e => setLocalLead({...localLead, name: e.target.value})} />
                                <input className="glass-input w-full p-2 rounded" placeholder="Destination" value={localLead.dest} onChange={e => setLocalLead({...localLead, dest: e.target.value})} />
                                <div className="flex gap-2">
                                    <input className="glass-input w-1/2 p-2 rounded" placeholder="Budget" value={localLead.budget} onChange={e => setLocalLead({...localLead, budget: e.target.value})} />
                                    <input className="glass-input w-1/2 p-2 rounded" type="number" placeholder="Pax" value={localLead.pax} onChange={e => setLocalLead({...localLead, pax: e.target.value})} />
                                </div>
                            </div>
                        </div>
                        <div className="glass-panel p-4">
                            <h3 className="text-slate-400 font-bold text-xs mb-2">ADD-ONS</h3>
                            <div className="text-xs text-slate-300 mb-2">
                                <b>World Clock:</b><br/>
                                üá∫üá∏ NY: {new Date().toLocaleTimeString('en-US', {timeZone:'America/New_York', hour:'2-digit', minute:'2-digit'})}<br/>
                                üá∫üá∏ LA: {new Date().toLocaleTimeString('en-US', {timeZone:'America/Los_Angeles', hour:'2-digit', minute:'2-digit'})}
                            </div>
                            <div className="text-[10px] text-slate-500 grid grid-cols-4 gap-1"><span>A-Alpha</span><span>B-Bravo</span><span>C-Charlie</span><span>D-Delta</span><span>E-Echo</span><span>F-Foxtrot</span><span>G-Golf</span><span>H-Hotel</span></div>
                        </div>
                        <div className="glass-panel p-4 bg-slate-800/80 border border-green-500/30">
                            <h3 className="text-green-400 font-bold text-sm mb-3">Pricing Engine</h3>
                            <div className="flex gap-2 mb-2"><input type="number" className="glass-input w-full p-2 rounded" placeholder="Net Price" value={localLead.net} onChange={e => setLocalLead({...localLead, net: e.target.value})} /></div>
                            <div className="text-xs text-slate-400 mb-1">Markup: <span className="text-green-400">${localLead.markup}</span></div>
                            <input type="range" min="0" max="500" step="10" className="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-green-500 mb-4" value={localLead.markup} onChange={e => setLocalLead({...localLead, markup: e.target.value})} />
                            <div className="text-center">
                                <div className="text-xs text-slate-500">TOTAL QUOTE</div>
                                <div className="text-3xl font-bold text-white">${formatCurrency(totalAll).replace('$','')}</div>
                                <button onClick={saveDeal} className="mt-2 w-full bg-green-600 hover:bg-green-500 text-white py-1 rounded text-xs font-bold"><i className="fa-solid fa-check"></i> CH·ªêT ƒê∆†N (WIN)</button>
                            </div>
                        </div>
                    </div>
                    <div className="w-2/3 flex flex-col gap-4">
                        <div className="flex-1 glass-panel p-6 overflow-y-auto relative bg-slate-900/50">
                            {loading ? <div className="flex h-full items-center justify-center text-indigo-400 gap-2"><div className="loader"></div> AI Thinking...</div> : <pre className="whitespace-pre-wrap font-sans text-lg text-slate-200">{script}</pre>}
                        </div>
                        <div className="grid grid-cols-5 gap-2 h-16">
                            <button onClick={() => runScenario('intro')} className="glass-panel hover:bg-indigo-600/30 text-indigo-300 text-xs font-bold">Intro</button>
                            <button onClick={() => runScenario('price')} className="glass-panel hover:bg-green-600/30 text-green-300 text-xs font-bold">Quote $$$</button>
                            <button onClick={() => runScenario('obj_exp')} className="glass-panel hover:bg-orange-600/30 text-orange-300 text-xs font-bold">Cheap?</button>
                            <button onClick={() => runScenario('obj_wife')} className="glass-panel hover:bg-orange-600/30 text-orange-300 text-xs font-bold">Wife?</button>
                            <button onClick={() => runScenario('close')} className="glass-panel hover:bg-red-600/30 text-red-300 text-xs font-bold">CLOSE!</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- LINK HUNTER TAB ---
        const LinkHunterTab = ({ apiKeys, addToKnowledge, pushScriptUrl }) => {
            const [input, setInput] = useState("");
            const [log, setLog] = useState("");
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState("");

            const process = async () => {
                if(!input) return alert("Input!"); setLoading(true); setLog("Scanning...");
                try {
                    const url = extractUrlFromInput(input);
                    if(!url) throw new Error("No URL");
                    setLog(`Target: ${url.substring(0,30)}...`);
                    const { blob, type } = await downloadFileFromUrl(url, setLog);
                    setLog(`Size: ${(blob.size/1024/1024).toFixed(2)}MB`);
                    
                    let prompt = type.includes('video') ? "Training expert. Summarize video guideline to VIETNAMESE. Keep ENG terms." : "Extract text/guideline to VIETNAMESE.";
                    const text = await generateContentWithRetry(apiKeys, prompt, blob, type, setLog);
                    setResult(text);
                    addToKnowledge(text);
                    if (pushScriptUrl) await pushToCloud(pushScriptUrl, text, setLog);
                } catch(e) { setLog(e.message); } finally { setLoading(false); }
            };

            return (
                <div className="p-6 h-full flex flex-col">
                    <h2 className="text-xl font-bold text-white mb-4">Link Hunter (Training)</h2>
                    <div className="flex gap-2 mb-4">
                        <input className="glass-input flex-1 p-2 rounded" placeholder="Paste <video> tag or URL..." value={input} onChange={e => setInput(e.target.value)} />
                        <button onClick={process} disabled={loading} className="bg-indigo-600 text-white px-6 rounded font-bold">{loading ? "..." : "Analyze"}</button>
                    </div>
                    <div className="bg-slate-900 p-2 text-xs font-mono text-green-400 h-20 overflow-y-auto mb-4 border border-slate-700">{log}</div>
                    <div className="flex-1 glass-panel p-4 overflow-y-auto text-slate-300 text-sm whitespace-pre-wrap">{result}</div>
                </div>
            );
        };

        // --- KNOWLEDGE TAB (RESTORED FULL) ---
        const KnowledgeTab = ({ knowledgeBase, apiKeys, addToKnowledge, sheetUrl, setKnowledgeBase, pushScriptUrl }) => {
            const [search, setSearch] = useState("");
            const [selectedItem, setSelectedItem] = useState(null);
            const [syncing, setSyncing] = useState(false);
            const [organizing, setOrganizing] = useState(false);
            const filtered = knowledgeBase.filter(item => item.content.toLowerCase().includes(search.toLowerCase()) || item.date.includes(search));

            const syncFromSheet = async () => {
                if (!sheetUrl) return alert("Ch∆∞a c√†i CSV Link! V√†o Tab Settings.");
                setSyncing(true);
                try {
                    const response = await fetch(sheetUrl);
                    if (!response.ok) throw new Error("L·ªói t·∫£i Sheet.");
                    const rows = parseCSV(await response.text());
                    const newItems = [];
                    for(let i = 1; i < rows.length; i++) { if(rows[i].length >= 2 && rows[i][1].trim()) newItems.push({ date: rows[i][0] || "?", content: rows[i][1] }); }
                    setKnowledgeBase(newItems); alert(`ƒê√£ t·∫£i v·ªÅ ${newItems.length} m·ª•c!`);
                } catch (e) { alert("L·ªói: " + e.message); } finally { setSyncing(false); }
            };

            const handleOrganize = async () => {
                if (apiKeys.length === 0) return alert("C·∫ßn Key!");
                setOrganizing(true);
                try {
                    const allContent = knowledgeBase.map(k => `[${k.date}]: ${k.content}`).join("\n---\n");
                    const prompt = `Th·ªß th∆∞ chuy√™n nghi·ªáp. S·∫Øp x·∫øp th√†nh GUIDELINE duy nh·∫•t theo Ch·ªß ƒê·ªÅ. Lo·∫°i b·ªè √Ω tr√πng. Gi·ªØ thu·∫≠t ng·ªØ Anh. Ti·∫øng Vi·ªát.\n\n${allContent}`;
                    const organizedText = await generateContentWithRetry(apiKeys, prompt, null, null, null);
                    const newItem = `== üìö B·∫¢N AI T·ªîNG H·ª¢P (${new Date().toLocaleDateString()}) ==\n\n${organizedText}`;
                    addToKnowledge(newItem);
                    if (pushScriptUrl) { await pushToCloud(pushScriptUrl, newItem, null); alert("ƒê√£ t·ªïng h·ª£p v√† ƒê·∫®Y L√äN SHEET th√†nh c√¥ng!"); }
                } catch (e) { alert("L·ªói: " + e.message); } finally { setOrganizing(false); }
            };

            return (
                <div className="p-6 h-full flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3"><h2 className="text-2xl font-bold text-white">Kho Ki·∫øn Th·ª©c</h2><span className="bg-slate-700 text-xs px-2 py-1 rounded text-slate-300">{knowledgeBase.length} m·ª•c</span></div>
                        <div className="flex gap-2">
                            <button onClick={syncFromSheet} disabled={syncing} className={`px-4 py-2 rounded-lg text-sm border flex items-center gap-2 transition-all ${syncing ? 'bg-green-700/50' : 'bg-green-600 hover:bg-green-500 border-green-500 text-white'}`}>{syncing ? <i className="fa-solid fa-sync fa-spin"></i> : <i className="fa-solid fa-cloud-arrow-down"></i>} {syncing ? "ƒêang t·∫£i..." : "K√©o t·ª´ Cloud"}</button>
                            <button onClick={handleOrganize} disabled={organizing} className={`px-4 py-2 rounded-lg text-sm border flex items-center gap-2 transition-all ${organizing ? 'bg-slate-600' : 'bg-violet-600 hover:bg-violet-500 border-violet-500 text-white'}`}>{organizing ? <i className="fa-solid fa-circle-notch fa-spin"></i> : <i className="fa-solid fa-brain"></i>} AI T·ªïng H·ª£p</button>
                        </div>
                    </div>
                    <div className="relative mb-4"><i className="fa-solid fa-search absolute left-4 top-3.5 text-slate-500"></i><input type="text" placeholder="T√¨m ki·∫øm..." className="w-full glass-input pl-10 pr-4 py-3 rounded-xl" value={search} onChange={(e) => setSearch(e.target.value)} /></div>
                    <div className="flex gap-4 flex-1 overflow-hidden">
                        <div className="w-1/3 glass-panel overflow-y-auto">
                            {filtered.map((item, idx) => (
                                <div key={idx} onClick={() => setSelectedItem(item)} className={`p-4 border-b border-slate-700/50 cursor-pointer hover:bg-slate-700/30 ${selectedItem === item ? 'bg-slate-700/50 border-l-4 border-cyan-500' : ''}`}>
                                    <div className="flex justify-between items-center mb-1"><div className="text-xs text-slate-500">{item.date}</div>{item.content.includes("üìö") && <span className="text-[10px] bg-violet-600/30 text-violet-300 px-1 rounded">AI</span>}</div>
                                    <div className="font-medium text-slate-200 line-clamp-2">{item.content.replace("== üìö B·∫¢N AI T·ªîNG H·ª¢P", "üìö T·ªîNG H·ª¢P").substring(0, 60)}...</div>
                                </div>
                            ))}
                        </div>
                        <div className="w-2/3 glass-panel p-6 overflow-y-auto bg-slate-900/50">{selectedItem ? (<pre className="whitespace-pre-wrap font-sans text-sm text-slate-300 leading-relaxed">{selectedItem.content}</pre>) : (<div className="text-slate-500 text-center mt-20">Ch·ªçn m·ª•c ƒë·ªÉ xem</div>)}</div>
                    </div>
                </div>
            );
        };

        // --- CONSULT TAB (RESTORED FULL) ---
        const ConsultTab = ({ apiKeys, knowledgeBase }) => {
            const [pastedImage, setPastedImage] = useState(null);
            const [loading, setLoading] = useState(false);
            const [advice, setAdvice] = useState("");
            const [question, setQuestion] = useState("");

            useEffect(() => {
                const handlePaste = (e) => { const items = e.clipboardData.items; for (let i = 0; i < items.length; i++) { if (items[i].type.indexOf("image") !== -1) { setPastedImage(items[i].getAsFile()); setAdvice(""); break; } } };
                window.addEventListener("paste", handlePaste); return () => window.removeEventListener("paste", handlePaste);
            }, []);

            const handleConsult = async () => {
                if (apiKeys.length === 0) return alert("C·∫ßn Key!");
                setLoading(true); 
                try {
                    const context = knowledgeBase.slice(0, 10).map(k => k.content).join("\n").substring(0, 10000); 
                    const prompt = `T∆∞ v·∫•n vi√™n. Ki·∫øn th·ª©c: --- ${context} --- \nC√¢u h·ªèi: "${question}" \nGi·∫£i quy·∫øt v·∫•n ƒë·ªÅ.`;
                    const text = await generateContentWithRetry(apiKeys, prompt, pastedImage, pastedImage?.type || 'text/plain', null);
                    setAdvice(text);
                } catch (err) { setAdvice("L·ªói: " + err.message); } finally { setLoading(false); }
            };

            return (
                <div className="p-6 h-full flex flex-col">
                    <h2 className="text-2xl font-bold mb-4 text-white">T∆∞ V·∫•n & Fix L·ªói</h2>
                    <div className="flex gap-6 h-full">
                        <div className="w-1/2 flex flex-col gap-4">
                            <div className="glass-panel p-4 flex-1 flex flex-col items-center justify-center border-dashed border-2 border-slate-600 relative overflow-hidden">
                                {pastedImage ? ( <img src={URL.createObjectURL(pastedImage)} className="max-h-full object-contain z-10" /> ) : ( <div className="text-center text-slate-400"><i className="fa-regular fa-clipboard text-5xl mb-3 opacity-50"></i><p>Ctrl + V ƒë·ªÉ d√°n ·∫£nh l·ªói</p></div> )}
                            </div>
                            <textarea className="glass-input w-full h-24 p-3 rounded-xl resize-none" placeholder="Nh·∫≠p c√¢u h·ªèi..." value={question} onChange={(e) => setQuestion(e.target.value)}></textarea>
                            <button onClick={handleConsult} disabled={loading} className="w-full py-3 rounded-xl font-bold text-white bg-orange-600 hover:bg-orange-500 shadow-lg transition-all">{loading ? "ƒêang x·ª≠ l√Ω..." : "GI·∫¢I QUY·∫æT"}</button>
                        </div>
                        <div className="w-1/2 glass-panel p-6 overflow-y-auto bg-slate-900/50"><pre className="whitespace-pre-wrap font-sans text-sm text-slate-300 leading-relaxed">{advice}</pre></div>
                    </div>
                </div>
            );
        };

        // --- SETTINGS TAB (RESTORED FULL) ---
        const SettingsTab = ({ apiKeys, setApiKeys, clearData, sheetUrl, setSheetUrl, pushScriptUrl, setPushScriptUrl }) => {
            const [newKey, setNewKey] = useState("");
            return (
                <div className="p-6">
                    <h2 className="text-xl font-bold text-white mb-4">Settings</h2>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="glass-panel p-4">
                            <h3 className="text-sm font-bold text-green-400 mb-2">Cloud READ (CSV)</h3>
                            <input className="glass-input w-full p-2 rounded text-xs" placeholder="https://.../pub?output=csv" value={sheetUrl} onChange={e => setSheetUrl(e.target.value)} />
                        </div>
                        <div className="glass-panel p-4">
                            <h3 className="text-sm font-bold text-violet-400 mb-2">Cloud WRITE (Apps Script)</h3>
                            <input className="glass-input w-full p-2 rounded text-xs" placeholder="https://script.google.com/.../exec" value={pushScriptUrl} onChange={e => setPushScriptUrl(e.target.value)} />
                        </div>
                    </div>
                    <div className="glass-panel p-4">
                        <h3 className="text-sm font-bold text-indigo-400 mb-2">API Keys ({apiKeys.length})</h3>
                        <textarea className="glass-input w-full h-32 p-2 rounded text-xs font-mono" value={apiKeys.join('\n')} onChange={e => setApiKeys(e.target.value.split('\n').filter(k=>k.trim()))} />
                        <div className="text-xs text-slate-500 mt-2">One key per line. System auto-rotates on 429/503 errors.</div>
                    </div>
                    <button onClick={() => {if(confirm("Clear All Data?")) {clearData();}}} className="mt-4 border border-red-500 text-red-500 px-4 py-2 rounded text-xs hover:bg-red-500/10">Factory Reset</button>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('crm');
            const [apiKeys, setApiKeys] = useState(() => JSON.parse(localStorage.getItem('dp_keys')) || DEFAULT_KEYS);
            const [leads, setLeads] = useState(() => JSON.parse(localStorage.getItem('dp_leads')) || []);
            const [knowledge, setKnowledge] = useState(() => JSON.parse(localStorage.getItem('dp_kb')) || []);
            const [sheetUrl, setSheetUrl] = useState(localStorage.getItem('dp_sheet_url') || "");
            const [pushScriptUrl, setPushScriptUrl] = useState(localStorage.getItem('dp_push_url') || "");
            const [activeLead, setActiveLead] = useState(null);

            useEffect(() => localStorage.setItem('dp_keys', JSON.stringify(apiKeys)), [apiKeys]);
            useEffect(() => localStorage.setItem('dp_leads', JSON.stringify(leads)), [leads]);
            useEffect(() => localStorage.setItem('dp_kb', JSON.stringify(knowledge)), [knowledge]);
            useEffect(() => localStorage.setItem('dp_sheet_url', sheetUrl), [sheetUrl]);
            useEffect(() => localStorage.setItem('dp_push_url', pushScriptUrl), [pushScriptUrl]);

            const addToKnowledge = (txt) => setKnowledge([{date: new Date().toLocaleString(), content: txt}, ...knowledge]);
            
            const handleSelectLead = (lead) => {
                setActiveLead(lead);
                setActiveTab('sales');
            };

            const handleUpdateLead = (updatedLead) => {
                setLeads(leads.map(l => l.id === updatedLead.id ? updatedLead : l));
                setActiveLead(updatedLead);
            };

            return (
                <div className="flex h-screen w-full relative">
                    <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-900/20 rounded-full blur-[120px] pointer-events-none"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-900/20 rounded-full blur-[120px] pointer-events-none"></div>

                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />

                    <div className="flex-1 m-4 ml-0 glass-panel overflow-hidden relative z-10 flex flex-col">
                        {activeTab === 'dashboard' && <DashboardTab leads={leads} />}
                        {activeTab === 'crm' && <CRMTab leads={leads} setLeads={setLeads} onSelectLead={handleSelectLead} />}
                        {activeTab === 'sales' && <SalesTab apiKeys={apiKeys} activeLead={activeLead} updateLead={handleUpdateLead} />}
                        {activeTab === 'link_hunter' && <LinkHunterTab apiKeys={apiKeys} addToKnowledge={addToKnowledge} pushScriptUrl={pushScriptUrl} />}
                        {activeTab === 'knowledge' && <KnowledgeTab knowledgeBase={knowledge} apiKeys={apiKeys} addToKnowledge={addToKnowledge} sheetUrl={sheetUrl} setKnowledgeBase={setKnowledge} pushScriptUrl={pushScriptUrl} />}
                        {activeTab === 'consult' && <ConsultTab apiKeys={apiKeys} knowledgeBase={knowledge} />}
                        {activeTab === 'settings' && <SettingsTab apiKeys={apiKeys} setApiKeys={setApiKeys} clearData={() => {setLeads([]); setKnowledge([]);}} sheetUrl={sheetUrl} setSheetUrl={setSheetUrl} pushScriptUrl={pushScriptUrl} setPushScriptUrl={setPushScriptUrl} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
